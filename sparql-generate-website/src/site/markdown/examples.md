# Get Started

`sparql-generate-jena` is an implementation of SPARQL-Generate over Apache Jena.

## Release of version 0.10:

Version 0.10 is released to Maven central and can be used as a dependency to your maven project: the most simple is to add the following maven dependency in your Java maven project file ( `*.pom` file):
 
```xml
<dependency>
    <groupId>com.github.thesmartenergy</groupId>
    <artifactId>sparql-generate-jena</artifactId>
    <version>0.10</version>
</dependency>
```

Version 0.10 implements:

- The following iterator functions:
    - CSS3 Selectors: <http://w3id.org/sparql-generate/ite/CSS3>
    - CSV: ...
    - CSV: ...
    - Regex: ...
- The follownig custom SPARQL functions:
    - CSS3 Selectors: <http://w3id.org/sparql-generate/fn/CSS3>
    - CSV: ...
    - CSV: ...
    - Regex: ...

Version 0.9 implements:

- keywords `GENERATE` and `ITERATOR`;
- sub-GENERATE queries --> URI or Template;
- The following iterator functions:
    - List the keys of a JSON object: <http://w3id.org/sparql-generate/ite/JSONListKeys>
    - JSON Path: <http://w3id.org/sparql-generate/ite/JSONPath>
    - XPath: <http://w3id.org/sparql-generate/ite/XPath>
- The follownig custom SPARQL functions:
    - JSON Path: <http://w3id.org/sparql-generate/fn/JSONPath>
    - XPath: <http://w3id.org/sparql-generate/fn/XPath>


The code is well documented and the javadoc contains description and examples of the main classes and methods. See http://w3id.org/sparql-generate/apidocs/index.html 


## Code examples

The following sections illustrate some of the capabilities of `sparql-generate-jena-0.10`

### Parsing a Query

```java
 String queryString = "PREFIX ... GENERATE {...} FROM ... SOURCE ... ITERATOR ... WHERE {...}";
 Syntax syntax = SPARQLGenerate.SYNTAX;
 SPARQLGenerateQuery query = (SPARQLGenerateQuery) QueryFactory.create(queryString, syntax);
```

### Classes `PlanFactory` and `RootPlan`

First use an instance of `PlanFactory` to instantiate a `RootPlan` for a SPARQL-Generate query.

```java
SPARQLGenerateQuery query;
PlanFactory factory = new PlanFactory();
RootPlan plan = factory.create(query);
```

Then the `RootPlan` can be executed several times on different SPARQL datasets, and with different initial bindings (i.e., on multiple _messages_). Call one of the `exec` methods to trigger the RDF generation. Here is the signature of two of these methods:

```java
Model exec();
void exec(Model inputModel, QuerySolution initialBindings, Model initialModel);
void exec(Dataset inputDataset, QuerySolution initialBindings, Model initialModel);
```

### Retrieving the generated RDF

RDF generated by the execution plan is added to a `Model`, which is the Jena class for a RDF Graph.

- some `exec` methods create a new model from scratch at execution time, fill it with the generated triples, and return it to the caller;
- other method use parameter `initialModel`, and add triples. 

To instantiate a `Model`, which is the Jena model for a RDF Graph, one may use:

```java
ModelFactory.createDefaultModel();
```


### Evaluating a query over a SPARQL Dataset

Part of the SPARQL GENERATE query execution consists in evaluating a SPARQL 1.1 `SELECT *` query over a RDF Graph, or a SPARQL Dataset. Exactly like in SPARQL 1.1. The corresponding parameters are `inputModel` or `inputDataset`. To instantiate a `Dataset`, which is the Jena class for a SPARQL Dataset, one may use:

```java
DatasetFactory.create(Model);
```

Note:

- If `initialModel == null`, then an `IllegalArgumentException` exception will be thrown;
- The behaviour when the same instance is passed as `inputModel` and `initialModel` is not specified.


### Generating RDF for streams of messages

Finally, one may execute the query with initial bindings. This is useful when one wants to apply the same plan to generate RDF from multiple messages regularly received from a lightweight sensor for instance. 

Suppose one needs to execute a plan with a variable `?msg` bound to a message with textual representation `"mymessage"`and internet media-type _application/json_. Then the RDF literal to bind to `?msg`:

- has lexical form `"mymessage"`
- has datatype IRI `<urn:iana:mime:application/json>`

In SPARQL Generate over Apache Jena, one calls an `exec` method with parameter `initialBindings`. The following code shows how this can be done with the plan instantiated above:

```java
String variable = "msg";
String message = "mymessage";
String uri = "urn:iana:mime:application/json";

QuerySolutionMap initialBinding = new QuerySolutionMap();
Model initialModel = ModelFactory.createDefaultModel();

TypeMapper typeMapper = TypeMapper.getInstance();
RDFDatatype dt = typeMapper.getSafeTypeByName(uri);
Node arqLiteral = NodeFactory.createLiteral(message, dt);
RDFNode jenaLiteral = initialModel.asRDFNode(arqLiteral);
initialBinding.add(variable, jenaLiteral);

plan.exec(initialBinding, initialModel);
```


### Using a File Manager

In many use cases, it is useful to use local files instead of operating HTTP GET requests. The Jena FileManager is designed just for that. It uses a configuration file to load files from disk instead of attempting HTTP GET calls. See
[https://jena.apache.org/documentation/notes/file-manager.html](The Jena FileManager and LocationMapper). The following code illustrates how a `FileManager` can be passed to the constructor of a `PlanFactory`, in order to be used during the execution of the plans this `PlanFactory` will create.

```java
Model conf = RDFDataMgr.loadModel("file:/path/to/configuration.ttl");
LocationMapper mapper = new LocationMapper(conf);
FileManager fm = new FileManager();

fm.setLocationMapper(mapper);

Locator loc = new LocatorFile("file:/path/to/directory1");
Locator loc = new LocatorFile("file:/path/to/directory2");
fm.addLocator(loc);

PlanFactory factory = new PlanFactory(fm);
...

```


## Contribute to sparql-generate

We are currently in the process of debugging and writing multiple unit tests. Do not hesitate to propose tests, additions,  report bugs, or just say hello:

- The issue tracker - http://github.com/thesmartenergy/sparql-generate/issues
- The mailing list - https://groups.google.com/forum/#!forum/sparql-generate-jena